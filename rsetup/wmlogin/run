#!/bin/zsh

mkdir -p ~/.logs/

echo > ~/.logs/wmlogin.log

if [ "x${HOST}" = "x" ]
then
    HOST=$HOSTNAME
fi
if [ "x${HOST}" != "x" ]
then
    __comp=wmlogin

    if [ -d ~/.rsetup/${__comp}/run.d/${HOST} ]
    then
        rm -rf ~/.rsetup/${__comp}/run.d/${HOST}
    fi
    if [ ! -x ~/.rsetup/${__comp}/run.d/${HOST} ]
    then
        mkdir ~/.rsetup/${__comp}/run.d/
        cp ~/.rsetup/${__comp}/run.tmpl ~/.rsetup/${__comp}/run.d/${HOST}
    fi

    if [ -r ~/.rsetup/${__comp}/run.d/${HOST} ]
    then
        ~/.rsetup/${__comp}/run.d/${HOST}
    fi

    unset __comp
else
    print env var HOST is not set $HOST
fi





# give access to mpd

notify-send wmlogin/run "starting wmlogin/run" &!

echo wmlogin/run "starting wmlogin/run" >>& ~/.logs/wmlogin.log &!

if whence xte >& /dev/null
then
    xte <<EOF >>& ~/.logs/wmlogin.log &!
mousemove 42 42
EOF
fi

## ssh-agent access needed.
if whence -p xautolock >& /dev/null &&
       ! pgrep xautolock >& /dev/null
then
    xautolock -detectsleep >>& ~/.logs/wmlogin.log &!
fi

##{{
# may be very much required.
xdg-autostart &!
systemctl --user start gvfs-daemon.service
systemctl --user start gvfs-afc-volume-monitor.service
systemctl --user start gvfs-goa-volume-monitor.service
systemctl --user start gvfs-gphoto2-volume-monitor.service
systemctl --user start gvfs-metadata.service
systemctl --user start gvfs-mtp-volume-monitor.service
systemctl --user start gvfs-udisks2-volume-monitor.service
##}}

if whence -p conky >& /dev/null &&
       ! pgrep conky >& /dev/null
then
    conky -d -c ~/.conkyrc/main/conkyrc >& /dev/null &!
    ## NOTE watch need attached terminal to work.
    # if whence -p watch >& /dev/null
    # then
    #     echo NOTE running watch -t -n7 conky -c ~/.conkyrc/main/conkyrc >>& ~/.logs/wmlogin.log &!
    #     watch -t -n7 conky -c ~/.conkyrc/main/conkyrc >& /dev/null &!
    # else
    #     echo NOTE running conky -d -c ~/.conkyrc/main/conkyrc >>& ~/.logs/wmlogin.log &!
    #     conky -d -c ~/.conkyrc/main/conkyrc >& /dev/null &!
    # fi
fi

if whence xte >& /dev/null
then
    xte <<EOF >>& ~/.logs/wmlogin.log
mousemove 42 42
EOF
fi

# ~/bin/syncimap -r               # enable, done in rsetup/x/run

# laptop power monitoring.
if whence -p ~/bin/power-mon >& /dev/null
then
    ~/bin/power-mon >>& ~/.logs/wmlogin.log &!
fi

if whence -p redshift >& /dev/null &&
       ! pgrep redshift >& /dev/null
then
    redshift -t 6500:5000 -b 1.0:0.8  >>& ~/.logs/wmlogin.log &!
    ## NOTE watch need attached terminal to work.
    # if whence -p watch >& /dev/null
    # then
    #     echo NOTE running watch -t -n3 redshift -t 6500:5000 -b 1.0:0.8  >>& ~/.logs/wmlogin.log &!
    #     watch -t -n3 redshift -t 6500:5000 -b 1.0:0.8  >>& ~/.logs/wmlogin.log &!
    # else
    #     echo NOTE running redshift -t 6500:5000 -b 1.0:0.8  >>& ~/.logs/wmlogin.log &!
    #     redshift -t 6500:5000 -b 1.0:0.8  >>& ~/.logs/wmlogin.log &!
    # fi
fi


atq
if [ $(atq | cut -f1 | wc -l) -gt 0 ]
then
    atrm  $(atq | cut -f1)
fi

if whence -p xsetroot >& /dev/null
then
    # https://unix.stackexchange.com/questions/69033/mouse-cursor-became-a-big-x
    # https://unix.stackexchange.com/questions/371166/i-like-the-default-x-shaped-crosshair-cursor-in-linux-how-do-i-force-debian-t
    # xsetroot -cursor_name X_cursor
    echo NOTE running xsetroot -cursor_name left_ptr >>& ~/.logs/wmlogin.log &!
    xsetroot -cursor_name left_ptr >>& ~/.logs/wmlogin.log &!
fi

if whence -p ~/bin/wallpaper-setup >& /dev/null
then
    # WM specific setup
    ~/bin/wallpaper-setup >>& ~/.logs/wmlogin.log &!
    # ~/bin/stumpwm-setup &!
fi

emacs_daemon_start              # in case it were not started in x/run

#### # if [ -x /usr/libexec/at-spi-registryd ]
#### then
#### #     DISPLAY=:0.0 dbus-launch --autolaunch=$MY_DBUS_SESSION /usr/libexec/at-spi-registryd &!
#### #  elif [  -x  /usr/lib/at-spi2-core/at-spi2-registryd ]
#### then
#### #     DISPLAY=:0.0 dbus-launch --autolaunch=$MY_DBUS_SESSION /usr/lib/at-spi2-core/at-spi2-registryd &!
#### # fi
####
####
#### # whence -p gnome-screensaver &&
#### # pgrep gnome-screensaver ||
#### # gnome-screensaver &!
####
#### if [ -x /usr/lib/gnome-settings-daemon/gnome-settings-daemon ]
#### then
####     pgrep gnome-settings >& /dev/null || /usr/lib/gnome-settings-daemon/gnome-settings-daemon &!
#### elif [ -x /usr/libexec/gnome-settings-daemon ]
#### then
####     pgrep gnome-settings >& /dev/null || /usr/libexec/gnome-settings-daemon &!
#### else
####     whence -p gnome-settings-daemon &&
####     pgrep gnome-settings >& /dev/null || gnome-settings-daemon &!
####     sleep 1s;
#### fi
####
####
####
####
#### if [ -x  /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 ]
##### then
####     pgrep gnome-settings >& /dev/null ||  /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 &!
####     sleep 1s;
#### elif [ -x /usr/libexec/polkit-gnome-authentication-agent-1 ]
#### then
####     pgrep gnome-settings >& /dev/null || /usr/libexec/polkit-gnome-authentication-agent-1 &!
####     sleep 1s;
#### else
####     whence -p polkit-gnome-authentication-agent-1 >& /dev/null &&
####     pgrep polkit-gnome >& /dev/null || polkit-gnome-authentication-agent-1 &!
####     sleep 1s;
#### fi
####
####
#### # pgrep gnome-keyring-d >& /dev/null || /usr/bin/gnome-keyring-daemon --start --foreground --components=secrets  &!
#### sleep 1s;
####
#### pgrep goa-daemon || DISPLAY=:0.0 dbus-launch --autolaunch=$MY_DBUS_SESSION /usr/lib/gnome-online-accounts/goa-daemon &!
#### sleep 1s;
#### pgrep nm-applet >& /dev/null || nm-applet --sm-disable &!
#### sleep 1s;
####
####
#### # pgrep empathy ||
#### # DISPLAY=:0.0 dbus-launch --autolaunch=$MY_DBUS_SESSION empathy &!
####
#### if whence -p syndaemon >& /dev/null ; then
####     syndaemon -i 1 -d &!
####     sleep 1s;
####     whence -p synclient >& /dev/null &&
####     pgrep synclient >& /dev/null ||
####     synclient TouchpadOff=1 &!
####     sleep 1s;
#### fi
####
#### if [ -x /usr/lib/gvfs/gvfsd ]
#### then
####     ! pgrep gvfsd || /usr/lib/gvfs/gvfsd -r ~/.gvfs &!
#### fi
####
#### foreach prog (
####     ## it is automatically started by gdm, so no need to start it.
####     # gnome-keyring-daemon
####     gnome-power-manager
####     mail-notification
####     blueman-adapters
####     blueman-applet
####     bluetoothd
####     empathy
####     synergys
####     ) {
####         if whence -p $prog >& /dev/null && ! pgrep $prog[0,15] >& /dev/null ; then
####             $prog &!
####             echo started $prog >&2
#### 	    pgrep $prog[0,15] >&2
####             sleep 1s;
####         else
####             print Not starting $prog >&2
####         fi
####     }
####
####
#### if whence -p pidgin >& /dev/null && ! pgrep pidgin | grep -v orig | grep pidgin ; then
####     pidgin &!
####     print started pidgin >&2
####     pgrep pidgin >&2
####     sleep 1s
#### else
####     print Not starting pidgin >&2
#### fi
####
#### if whence xte ; then
####     xte <<EOF
#### mousemove 42 42
#### EOF
#### fi
####
#### pgrep xautolock >& /dev/null && xautolock -locknow &!
####
#### # ~/bin/syncimap -r               # enable, done in rsetup/x/run
#### echo stumpwmrc end here >&2
####
#### atq
#### if [ $(atq | cut -f1 | wc -l) -gt 0 ]
#### then
####     atrm  $(atq | cut -f1)
#### fi
####
####
#### # WM specific setup
#### ~/bin/wallpaper-setup &!
#### ~/bin/stumpwm-setup &!
####
#### # Android LinConnect
#### if [ -x ~/.linconnect/LinConnectServer/update.sh ] && ! pgrep linconnect_serv >& /dev/null ; then
####     # https://github.com/hauckwill/linconnect-server
####     # https://play.google.com/store/apps/details?id=com.willhauck.linconnectclient
####     rm -f ~/.logs/linconnect.1
####     mv ~/.logs/linconnect ~/.logs/linconnect.1
####     ~/.linconnect/LinConnectServer/main/linconnect_server.py >& ~/.logs/linconnect &!
#### fi
####
#### if [ -x /usr/share/android-notifier-desktop/run.sh ] &&
####     java -DconfigDir=~/.config -Djava.util.prefs.userRoot=$configDir/android-notifier-desktop \
####         -Djava.net.preferIPv4Stack=true -client -Xms8m -Xmx32m \
####         -jar /usr/share/android-notifier-desktop/android-notifier-desktop.jar -i |
####     grep "not" ; then
####     /usr/share/android-notifier-desktop/run.sh >& ~/.logs/android-notifier-desktop.log &!
#### fi
####
#### pgrep xautolock >& /dev/null && xautolock -locknow &!
####
####
#### ## ssh-agent access needed.
#### whence -p xautolock >& /dev/null &&
#### pgrep xautolock >& /dev/null ||
#### xautolock -detectsleep &!
####
#### whence -p conky >& /dev/null &&
#### pgrep conky >& /dev/null ||
#### conky &!
####
#### whence synclient >& /dev/null &&
#### pgrep synclient >& /dev/null ||
#### synclient  TapButton1=1
####
####
####
####



# pgrep xautolock >& /dev/null && xautolock -locknow &!
if pgrep xautolock >& /dev/null
then
    xautolock -locknow >> ~/.logs/wmlogin.log 2>&1 &!
fi

foreach prog (
    ## it is automatically started by gdm, so no need to start it.
    # gnome-keyring-daemon
    # gnome-power-manager
    # mail-notification
    # blueman-adapters
    # blueman-applet
    # bluetoothd
    # empathy
    gnome-settings-daemon       # need for low disk space warning. https://bugs.launchpad.net/ubuntu/+source/gnome-settings-daemon/+bug/881376
    # https://blogs.n1zyy.com/n1zyy/2009/02/06/ubuntu-housekeeping/
    synergys
) {
    if whence -p $prog >> ~/.logs/wmlogin.log 2>&1  &&
           ! pgrep $prog[0,15] >> ~/.logs/wmlogin.log 2>&1
    then
        $prog &!
        # echo started $prog >&2
	      pgrep $prog[0,15] >> ~/.logs/wmlogin.log 2>&1
        sleep 1s;
    else
        print Not starting $prog >> ~/.logs/wmlogin.log 2>&1
    fi
}

if [ -x /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 ]
then
    pgrep polkit-gnome-au >& /dev/null || /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 &!
fi


if whence -p keynav >& /dev/null  &&
       ! pgrep keynav >& /dev/null
then
    keynav >> ~/.logs/wmlogin.log 2>&1  &!
fi

# if whence -p skyped >& /dev/null &&
#    ! pgrep skyped >& /dev/null
# then
#     skyped -c ~/.skyped/skyped.conf >&/dev/null &!
# fi

# Android LinConnect
if [ -x ~/.linconnect/LinConnectServer/update.sh ] &&
       ! pgrep linconnect_serv >> ~/.logs/wmlogin.log 2>&1
then
    # https://github.com/hauckwill/linconnect-server
    # https://play.google.com/store/apps/details?id=com.willhauck.linconnectclient
    rm -f ~/.logs/linconnect.1
    mv ~/.logs/linconnect ~/.logs/linconnect.1
    ~/.linconnect/LinConnectServer/main/linconnect_server.py >& ~/.logs/linconnect >>& ~/.logs/wmlogin.log &!
fi

if [ -x /usr/share/android-notifier-desktop/run.sh ] &&
       java -DconfigDir=~/.config -Djava.util.prefs.userRoot=$configDir/android-notifier-desktop \
            -Djava.net.preferIPv4Stack=true -client -Xms8m -Xmx32m \
            -jar /usr/share/android-notifier-desktop/android-notifier-desktop.jar -i |
           grep "not" ; then
    /usr/share/android-notifier-desktop/run.sh >& ~/.logs/android-notifier-desktop.log &!
fi

if [ "x" != "x$EMACS_SERVER_NAME" ]
then
    echo Trying to run emacsclient
    if pgrep stumpwm >& /dev/null && whence -p stumpish >& /dev/null
    then
        ( sleep 30s; stumpish emacsclient ) &!
    else
        ( sleep 30s; emacsclient -d :0 -nc -f ~/.emacs.d/server/$EMACS_SERVER_NAME -e "(progn (message \"Default\"))" ) &!
    fi
fi

autocutsel -f &!

xcompmgr -a &!


### fonts start

gsettings set org.gnome.desktop.interface monospace-font-name 'Ubuntu Mono 08'&!
gsettings set org.gnome.desktop.interface document-font-name 'Sans 08' &!
gsettings set org.gnome.desktop.interface font-name 'Ubuntu 08' &!


### fonts end

# need to run in temporary terminal
(echo sleep 60s;
 sleep 60s ;
 echo 'URxvt.font: xft:DejaVu Sans Mono:size=07' |  xrdb -merge -
 echo timeout 2s ~/bin/get-imap-pass -u localhost
 if ! timeout 2s ~/bin/get-imap-pass -u localhost >& /dev/null ;
 then
     echo pkill gnome-keyr
     pkill gnome-keyr
     echo sleep 1s
     sleep 1s
     echo gnome-keyring-daemon --daemonize
     gnome-keyring-daemon --daemonize
     echo timeout 7s ~/bin/get-imap-pass -u localhost
     if timeout 7s ~/bin/get-imap-pass -u localhost
     then
         echo pkill gnome-keyr
         : pkill gnome-keyr
     fi
 fi
) &!



# xterm -e "ish -s bash -- echo Completed wmlogin/run " >> ~/.logs/wmlogin.log 2>&1 &!


notify-send test test &!
echo notify-send test test >>& ~/.logs/wmlogin.log &!

cat ~/.logs/wmlogin.log >> ~/.logs/wmlogin.log
